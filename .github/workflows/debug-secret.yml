name: "Gemini AI Dashboard"

on:
  push:
    branches-ignore:
      - 'ai-feedback'

jobs:
  update-review-dashboard:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Gemini CLI
        run: npm install -g @google/gemini-cli

      - name: Run Gemini Analysis
        id: gemini_run
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          # 1. Run Gemini on the current folder (.)
          # We send the output to a temporary file named 'gemini_output.md'
          gemini run "You are a Senior Laravel Developer. Review the code in this repository. Focus on: 1. Security Vulnerabilities (Critical) 2. Logic Bugs 3. Code Cleanliness. formatting: markdown." . > gemini_output.md
          
          # 2. Check if the command failed
          if [ $? -ne 0 ]; then
            echo "Gemini CLI failed!"
            cat gemini_output.md # Print error to logs
            exit 1
          fi

      - name: Update Dashboard Branch
        run: |
          git config --global user.name "Gemini AI"
          git config --global user.email "gemini-bot@google.com"
          
          # Switch to or create the feedback branch
          git checkout ai-feedback 2>/dev/null || git checkout --orphan ai-feedback
          git rm -rf . 2>/dev/null || true
          
          # Move the output file to REVIEW.md
          mv gemini_output.md REVIEW.md
          
          # Add timestamp
          echo -e "\n\n---\n*Generated at $(date)*" >> REVIEW.md
          
          # Commit and Push
          git add REVIEW.md
          git commit -m "Update AI Review"
          git push -f origin ai-feedback